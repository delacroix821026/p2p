<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >

<mapper namespace="com.newland.financial.p2p.mapping.RepayMapper">

    <resultMap id="BaseResultMap" type="com.newland.financial.p2p.domain.entity.Repay">
        <id column="ID" property="id" jdbcType="VARCHAR"/>
        <result column="ORDER_ID" property="orderId" jdbcType="VARCHAR"/>
        <result column="CONTRACTS_CODE" property="contractsCode" jdbcType="VARCHAR"/>
        <result column="TXN_AMT" property="txnAmt" jdbcType="NUMERIC"/>
        <result column="TERMS" property="terms" jdbcType="NUMERIC"/>
        <result column="AMOUNT" property="amount" jdbcType="NUMERIC"/>
        <result column="SUM_AMOUNT" property="sumAmount" jdbcType="NUMERIC"/>
        <result column="INSTALMENT_DATE" property="instalmentDate" jdbcType="TIMESTAMP"/>
        <result column="NEXT_DATE" property="nextDate" jdbcType="TIMESTAMP"/>
        <result column="PAY_TYPE" property="payType" jdbcType="VARCHAR"/>
        <result column="RESP_TIME" property="respTime" jdbcType="TIMESTAMP"/>
    </resultMap>

    <sql id="Base_Column_List">
        ID,ORDER_ID,CONTRACTS_CODE,TXN_AMT,TERMS,AMOUNT,SUM_AMOUNT,INSTALMENT_DATE,NEXT_DATE,PAY_TYPE,RESP_TIME
    </sql>

    <insert id="insertRepayInfo"  parameterType="com.newland.financial.p2p.domain.entity.Repay">
        INSERT INTO t_inst_repay (<include refid="Base_Column_List"/>) VALUES
        (#{id,jdbcType=VARCHAR},#{orderId,jdbcType=VARCHAR},#{contractsCode,jdbcType=VARCHAR},#{txnAmt,jdbcType=NUMERIC},
        #{terms,jdbcType=NUMERIC},#{amount,jdbcType=NUMERIC},#{sumAmount,jdbcType=NUMERIC},#{instalmentDate,jdbcType=TIMESTAMP},
        #{nextDate,jdbcType=TIMESTAMP},#{payType,jdbcType=VARCHAR},#{respTime,jdbcType=TIMESTAMP})
    </insert>

    <select id="findRepayInfo" resultMap="BaseResultMap" parameterType="com.newland.financial.p2p.domain.entity.Repay">
        SELECT ID,ORDER_ID,CONTRACTS_CODE FROM t_inst_repay
        WHERE ORDER_ID = #{orderId,jdbcType=VARCHAR}
        AND CONTRACTS_CODE = #{contractsCode,jdbcType=VARCHAR} AND TERMS = #{terms,jdbcType=NUMERIC}
    </select>

    <update id="updateRepayInfo" parameterType="com.newland.financial.p2p.domain.entity.Repay">
        UPDATE t_inst_repay SET
        ORDER_ID = #{orderId,jdbcType=VARCHAR},
        CONTRACTS_CODE = #{contractsCode,jdbcType=VARCHAR},
        TXN_AMT = #{txnAmt,jdbcType=NUMERIC},
        TERMS = #{terms,jdbcType=NUMERIC},
        AMOUNT = #{amount,jdbcType=NUMERIC},
        SUM_AMOUNT = #{sumAmount,jdbcType=NUMERIC},
        INSTALMENT_DATE = #{instalmentDate,jdbcType=TIMESTAMP},
        NEXT_DATE = #{nextDate,jdbcType=TIMESTAMP},
        PAY_TYPE = #{payType,jdbcType=VARCHAR},
        RESP_TIME = #{respTime,jdbcType=TIMESTAMP}
        WHERE ID = #{id}
    </update>

    <!--商户还款中订单查询-->
    <resultMap type="com.newland.financial.p2p.domain.entity.Repay" id="BaseResultRepayMap">
        <id column="ID" property="id" />
        <result column="ORDER_ID" property="orderId"/>
        <result column="CONTRACTS_CODE" property="contractsCode" />
        <result column="TXN_AMT" property="txnAmt" />
        <result column="TERMS" property="terms" />
        <result column="AMOUNT" property="amount" />
        <result column="SUM_AMOUNT" property="sumAmount" />
        <result column="INSTALMENT_DATE" property="instalmentDate" />
        <result column="NEXT_DATE" property="nextDate"/>
        <result column="PAY_TYPE" property="payType"/>
        <result column="RESP_TIME" property="respTime"/>
        <association property="orderInfo" javaType="com.newland.financial.p2p.domain.entity.OrderInfo" >
            <id property="id" column="id" />
            <result property="txnTime" column="txnTime" />
            <result property="merId" column="merId" />
            <result property="txnAmt" column="txnAmt" />
            <result property="txnterms" column="txnterms" />
            <result property="orderId" column="orderId" />
            <result property="userId" column="userId" />
            <result property="accName" column="accName" />
            <result property="accNo" column="accNo" />
            <result property="validity" column="validity" />
            <result column="accIdcard" property="accIdcard" />
            <result column="accMobile" property="accMobile" />
            <result column="CVN2" property="cvn2" />
            <result column="discount" property="discount" />
            <result column="contractsCode" property="contractsCode" />
            <result column="amount" property="amount" />
            <result column="queryId" property="queryId" />
            <result column="poundage" property="poundage" />
            <result column="contractsState" property="contractsState" />
            <result column="sumTerms" property="sumTerms" />
            <result column="sumAmount" property="sumAmount" />
            <result column="remainAmount" property="remainAmount" />
            <result column="cancelAmount" property="cancelAmount" />
            <result column="cancelInterest" property="cancelInterest" />
            <result column="valueAdded" property="valueAdded" />
            <result column="createTime" property="createTime" />
            <result column="stus" property="stus" />
            <result column="openId" property="openId" />
        </association>
    </resultMap>
    <select id="findRepayList" resultMap="BaseResultRepayMap" parameterType="Map">
        SELECT
        rd.*,re.*
        FROM
        t_inst_orderinfo rd,t_inst_repay re
        <where>
            rd.contractsState = 1
            and
            rd.orderId = re.ORDER_ID
            <if test="merchantId != null">
                and rd.merchantId like CONCAT('%','${merchantId}','%')
            </if>
            <if test="merName != null">
                and rd.merName like CONCAT('%','${merName}','%')
            </if>
            <if test="orderId != null">
                and rd.orderId like CONCAT('%','${orderId}','%')
            </if> ORDER BY createTime desc
        </where>
    </select>

</mapper>